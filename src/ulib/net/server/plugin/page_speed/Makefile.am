## Makefile.am for page speed plugin for uhttp

MAINTAINERCLEANFILES = Makefile.in

DEFAULT_INCLUDES = -I. -I$(top_srcdir)/include -I..

ulib_la = $(top_builddir)/src/ulib/lib@ULIB@.la

moduledir = $(libexecdir)/ulib

module_LTLIBRARIES = mod_pagespeed.la

# Path to the root of the page speed build tree.
pagespeed_root_dir = @PAGESPEED_ROOT_DIR@

# The page speed libraries we depend on.
PAGESPEED_DEPS = \
        pagespeed/html/libpagespeed_html.a \
        third_party/jsmin/libjsmin.a \
        pagespeed/cssmin/libpagespeed_cssmin.a \
        third_party/instaweb/src/net/instaweb/libinstaweb_htmlparse_core.a \
        third_party/instaweb/src/net/instaweb/libinstaweb_rewriter_html.a \
        third_party/instaweb/src/net/instaweb/libinstaweb_util_core.a \
        pagespeed/core/libpagespeed_init.a \
        build/temp_gyp/libgoogleurl.a \
        pagespeed/image_compression/libpagespeed_png_optimizer.a \
        pagespeed/image_compression/libpagespeed_jpeg_optimizer.a \
        pagespeed/image_compression/libpagespeed_jpeg_reader.a \
        third_party/libpng/libpng.a \
        third_party/libjpeg_trans/libjpeg_trans.a \
        third_party/libjpeg/libjpeg.a \
        third_party/optipng/libpngxrgif.a \
        third_party/optipng/libopngreduc.a \
        base/libbase.a

#       net/libnet_base.a \
#       pagespeed/image_compression/libpagespeed_image_attributes_factory.a \
#       pagespeed/libpagespeed_library.a \
#       pagespeed/core/libpagespeed_core.a \
#       pagespeed/formatters/libpagespeed_formatters.a \
#       pagespeed/har/libpagespeed_har.a \
#       pagespeed/proto/libpagespeed_output_pb.a \
#       third_party/protobuf2/libprotobuf_lite.a \
#       third_party/modp_b64/libmodp_b64.a \
#       third_party/cJSON/libcJSON.a \
#       third_party/zlib/libchrome_zlib.a

# The following are used to specify the location of the generated
# libraries within the page speed SDK make build.
PAGESPEED_LIBS = $(addprefix $(pagespeed_root_dir)/out/Release/obj.target/, $(PAGESPEED_DEPS))

# ----------------------------------------------
# NB: compile with CXXFLAGS='-fPIC' make
# ----------------------------------------------
$(PAGESPEED_LIBS):
	CFLAGS='-fPIC -DPIC' CXXFLAGS='-fPIC -DPIC' $(MAKE) -C $(pagespeed_root_dir)

DEFAULT_INCLUDES += -I$(pagespeed_root_dir)/third_party/chromium/src \
    					  -I$(pagespeed_root_dir) \
						  -I$(pagespeed_root_dir)/third_party/instaweb/src \
						  -I$(pagespeed_root_dir)/third_party/protobuf2 \
						  -I$(pagespeed_root_dir)/third_party/protobuf2/src/src

DEFS = -DGOOGLE_PROTOBUF_NO_RTTI -DPAGESPEED_PNG_OPTIMIZER_GIF_READER -D__STDC_FORMAT_MACROS -DNDEBUG @DEFS@

mod_pagespeed_la_SOURCES = mod_pagespeed.cpp
mod_pagespeed_la_LDFLAGS = -Wl,--start-group $(PAGESPEED_LIBS) -Wl,--end-group -module $(MODULE_LIBTOOL_OPTIONS)
mod_pagespeed_la_LIBADD  = $(ulib_la) -lrt

clean-local:
	-rm -rf core .libs *.bb* *.da *.gcov *.la *.exe gmon.out
