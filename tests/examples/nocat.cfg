## -------------------------------------------------------------------------------
## userver - configuration parameters
## -------------------------------------------------------------------------------

userver {

#include "userver.cfg"

   PORT 5280 # nocat

   RUN_AS_USER apache

   USE_TCP_OPTIMIZATION yes

## -----------------------------------------------------------------------
## NB: MUST BE IN THIS WAY... (otherwise cannot share hash table of peers)
## -----------------------------------------------------------------------
## PREFORK_CHILD 0
## -----------------------------------------------------------------------

## LOG_FILE       syslog
   LOG_FILE       nocat.log
   LOG_FILE_SZ    1M
   LOG_MSG_SIZE   512

   PLUGIN      "( mod_nocat mod_http )"
   PLUGIN_DIR  ../../src/ulib/plugin/.libs
}

## -------------------------------------------------------------------------------
## mod_nocat - plugin parameters
## -------------------------------------------------------------------------------
## FIREWALL OPTIONS  vector of the params for setup the default firewall rules (write data to /tmp/firewall.opt)
##
## AUTH_SERVICE_IP   authservice address IP-based access control (IPADDR[/MASK])
## AUTH_SERVICE_URL  URL to the login service at the authservice. Must be set to the address of your authentication service
## LOGOUT_URL        URL to redirect user after logout
## LOGIN_TIMEOUT     Number of seconds after a client last login/renewal to terminate their connection
## DECRYPT_CMD       PGP command stuff
## DECRYPT_KEY       DES3 password stuff
## INIT_CMD          shell commands to  init          the firewall
## RESET_CMD         shell commands to reset          the firewall
## ACCESS_CMD        shell commands to open and close the firewall
## CHECK_BY_ARPING   metodo aggiuntivo per verificare la presenza di un peer nella tabella ARP (yes -> abilitato)
## ------------------------------------------------------------------------------------------------------------------------------------------

mod_nocat {

   ## ---------------------------------------------------------------------------------------------------------------------------------------------------
   ## FIREWALL OPTIONS (10): Allows you to tell the params to setup the default firewall rules  
   ## ---------------------------------------------------------------------------------------------------------------------------------------------------
   [
   ## 1 RouteOnly Required only if you DO NOT want your gateway to act as a NAT. Give this only if you are running a strictly routed
   ##             network, and do not need the gateway to enable NAT for you
   ""
## 1

   ## 2 DNSAddr   *If* you choose not to run DNS on your internal network, specify the address(es) of one or more domain name server
   ##             on the Internet that wireless clients can use to get out. Should be the same DNS that your DHCP server hands out
   192.168.253.254

   ## 3 IncludePorts Specify TCP ports to allow access to when public class users login. All others will be denied
   ""
## "22 80 443"

   ## 4 ExcludePorts Specify TCP ports to denied access to when public class users login. All others will be allowed. Note that you should
   ##                use either IncludePorts or ExcludePorts, but not both. If neither is specified, access is granted to all ports to public
   ##                class users. You should *always* exclude port 25, unless you want to run an portal for wanton spam sending. Users should
   ##                have their own way of sending mail. It sucks, but that is the way it is. Comment this out *only if* you are using IncludePorts
   ##                instead
   ""
## "23 25 111"

   ## 5 AllowedWebHosts List any domains that you would like to allow web access (TCP port 80 and 443) BEFORE logging in (this is the
   ##                   pre-skip stage, so be careful about what you allow
   ""
## "159.213.247.45 159.213.248.2"

   ## **************************************************************************************************************************************************
   ## NETWORK PARAMS (autodetected if not specified)
   ## **************************************************************************************************************************************************
   ## 6 ExternalDevice the interface connected to the Internet. Usually eth0 or eth1 under Linux, or maybe even ppp0 if you are running PPP or PPPoE
   eth0
   ## 7 InternalDevice Required if and only if your machine has more than two network interfaces. Must be set to the interface connected to your local
   ##                 network, normally your wireless card
   "eth0 eth0"
   ## 8 LocalNetwork  Must be set to the network address and net mask of your internal network. You can use the number of bits in the netmask
   ##                 (e.g. /16, /24, etc.) or the full x.x.x.x specification
   "127.0.0.1/32 10.30.1.0/24"
   ## **************************************************************************************************************************************************
   ## AUTOMATIC PARAMS ADDED BY THIS PLUGIN
   ## **************************************************************************************************************************************************
   ##  9 GatewayPort     The TCP port to bind the gateway service to. 5280 is de-facto standard for NoCatAuth. Change this only if you absolutely need to
   ## 10 AuthServiceAddr the address of your authentication service. You must use an IP address if DNS resolution is not available at gateway startup
   ]

   ## authservice address IP-based access control (IPADDR[/MASK])
   AUTH_SERVICE_IP    10.30.1.131,10.30.1.111

   ## URL to the login service at the authservice. Must be set to the address of your authentication service
   ## You must use an IP address if DNS resolution is not available at gateway startup
   AUTH_SERVICE_URL   "https://10.30.1.131/"

   ## URL to redirect user after logout
   LOGOUT_URL         "https://10.30.1.131/logout"

   ## Number of seconds after a client last login/renewal to terminate their connection
   ## Probably do not want to set this to less than 60 or a lot of bandwidth is likely to get consumed by the client renewal attempts
## LOGIN_TIMEOUT     86400 # one notification per day

   ## PGP command stuff
   DECRYPT_CMD       "/usr/bin/gpg --decrypt --homedir=/srv/wifi-portal/gpg --batch --decrypt --no-tty --status-file /tmp/gpg.status -o -"

   ## DES3 password stuff
   DECRYPT_KEY       200912281747

   ## setup the default firewall rules
   INIT_CMD          nocat/firewall/initialize.fw

   ## reset the default firewall rules
   RESET_CMD         nocat/firewall/reset.fw

   ## access control script to open and close firewall
   ## AUTOMATIC PARAMS(5) ADDED BY THIS PLUGIN: [action(permit|deny) mac ip class(Owner|Member|Public)] rulenum
   ACCESS_CMD        nocat/firewall/access.fw

   ## metodo aggiuntivo per verificare la presenza di un peer nella tabella ARP (yes -> abilitato)
   CHECK_BY_ARPING yes
}

## ------------------------------------------------------------------------------------------------------------------------------------------------
## mod_http - plugin parameters
## ------------------------------------------------------------------------------------------------------------------------------------------------
## ALIAS                      vector of URI redirection (request -> alias)
##
## VIRTUAL_HOST               flag to activate practice of maintaining more than one server on one machine, as differentiated by their apparent hostname 
## DIGEST_AUTHENTICATION      flag authentication method (yes = digest, no = basic)
## URI_PROTECTED_MASK         mask (DOS regexp) of URI protected from prying eyes
## URI_PROTECTED_ALLOWED_IP   list of comma separated client address for IP-based access control (IPADDR[/MASK]) for URI_PROTECTED_MASK
## ------------------------------------------------------------------------------------------------------------------------------------------

mod_http {

   ## ALIAS: Allows you to tell clients about documents that used to exist in your server's namespace, but do not anymore.
   ##       The client will make a request for the document at its new location
   [
   /printenv    /cgi-bin/printenv.sh
   ]

## VIRTUAL_HOST          yes
   DIGEST_AUTHENTICATION yes

   URI_PROTECTED_MASK         /cgi-bin/*
## URI_PROTECTED_ALLOWED_IP   127.0.0.1,10.30.0.0/16
}
