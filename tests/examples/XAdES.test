#!/bin/sh

. ../.function

start_msg XAdES

rm -f tsa_http.log TSA/log \
		out/sign.out err/sign.err \
		out/archive.out err/archive.err \
		out/verify.out err/verify.err \
		trace.*sign*.[0-9]* object.*sign*.[0-9]* stack.*sign*.[0-9]* \
		trace.*archive*.[0-9]* object.*archive*.[0-9]* stack.*archive*.[0-9]* \
		trace.*verify*.[0-9]* object.*verify*.[0-9]* stack.*verify*.[0-9]* \
		out/userver_tcp.out err/userver_tcp.err \
      trace.*userver_tcp*.[0-9]* object.*userver_tcp*.[0-9]* stack.*userver_tcp*.[0-9]*

#UTRACE="0 10M 0"
#UOBJDUMP="0 100k 10"
#USIMERR="error.sim"
#VALGRIND="valgrind -v --leak-check=full"
 export UTRACE UOBJDUMP USIMERR

if [ "$TERM" = "cygwin" ]; then
   export TMPDIR="C:/tmp"
	INPUT=/c/tmp/sign.b64
	SCHEMA=/c/msys/1.0/etc/XAdES/XAdESv141.xsd
	DOCUMENT=/c/msys/1.0/etc/XAdES/PROVE/TESTOPROVA.docx.b64
else
	INPUT=/tmp/sign.b64
	SCHEMA=/mnt/storage/stefano/XAdES/XAdESv141.xsd
	DOCUMENT=/mnt/storage/stefano/XAdES/PROVE/TESTOPROVA.docx.b64 # /mnt/storage/stefano/XAdES/PROVE/prima1.odt.b64 inp/XAdES/xmldsig-input.txt
fi

#STRACE=$TRUSS
#start_prg verify -c XAdES.ini -- $SCHEMA < $INPUT
#exit 0

DIR_CMD="../../examples/userver"

#STRACE=$LTRUSS
#start_prg_background userver_tcp -c tsa_http.cfg

 DIR_CA=../ulib/CA
#DIR_CA=/mnt/storage/stefano/MinGW/etc/CA
DATA_URI=$DOCUMENT
X509=`cat $DIR_CA/server.crt`
 KEY_HANDLE=$DIR_CA/server.key
#KEY_HANDLE=$DIR_CA/server_nopass.key
DIGEST_ALGORITHM=sha1
SIGNING_TIME=0
CLAIMED_ROLE="Amministratore UNIREL"
PRODUCTION_PLACE_CITY="sesto fiorentino"
PRODUCTION_PLACE_STATE_OR_PROVINCE=SI
PRODUCTION_PLACE_POSTAL_CODE=11111
PRODUCTION_PLACE_COUNTRY_NAME=Italy
CA_STORE=$DIR_CA/CApath
SIGNATURE_TIMESTAMP="http://localhost/tsa"

DIR_CMD="../../examples/XAdES"

 STRACE=$LTRUSS
start_prg sign -c XAdES.ini -- \
									 $DATA_URI \
									 '"$X509"' \
									 $KEY_HANDLE \
									 $DIGEST_ALGORITHM \
									 $SIGNING_TIME \
									 '"$CLAIMED_ROLE"' \
									 '"$PRODUCTION_PLACE_CITY"' \
									 $PRODUCTION_PLACE_STATE_OR_PROVINCE \
									 $PRODUCTION_PLACE_POSTAL_CODE \
									 $PRODUCTION_PLACE_COUNTRY_NAME \
									 $CA_STORE \
									 $SIGNATURE_TIMESTAMP < $DOCUMENT

 exit 0

# ------------------------------------------------------------
# sha1 check:
# ------------------------------------------------------------
# openssl dgst -sha1 -binary < content.xml | openssl base64 -e
# ------------------------------------------------------------
$OPENSSL base64 -e -in out/sign.out -out $INPUT

DIR_CMD="../../examples/XAdES"

ARCHIVE_TIMESTAMP="http://localhost/tsa"

#STRACE=$LTRUSS
start_prg archive -c XAdES.ini -- \
		 $ARCHIVE_TIMESTAMP < $INPUT

rm -f $INPUT
mv err/userver_tcp.err err/XAdES.err

$SLEEP
kill_prg userver_tcp TERM

$OPENSSL base64 -e -in out/archive.out -out $INPUT

#STRACE=$LTRUSS
start_prg verify -c XAdES.ini -- \
		 $SCHEMA < $INPUT

unzip -l	out/archive.out > out/XAdES.out

# Test against expected output
test_output_wc w XAdES
