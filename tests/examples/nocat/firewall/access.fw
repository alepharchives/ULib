#!/bin/sh

# VERY simple access control script for leeenux
# ---------------------------------------------------------------------------------------------------------------------------------------------------
# PARAMETERS: 5
# ---------------------------------------------------------------------------------------------------------------------------------------------------
#OPT=/tmp/firewall.opt
#
#if [ -f $OPT ]; then
#   i=1
#   while read LINE
#   do
#      eval v$i=\"$LINE\"
#      let "i = i + 1"
#   done < $OPT
#fi

action=$1
mac=$2
ip=$3
class=$4

if [ -z "$class" ]; then
   class=Public
fi

# Note: your PATH is inherited from the gateway process

IPTABLES=/usr/sbin/iptables

#if [ -z "$action" -o -z "$mac" -o -z "$ip" -o -z "$class" ]; then 
#    echo Usage: $0 [permit\|deny] [MAC] [IP] [Class]
#    echo Example: $0 permit 00:02:2d:aa:bb:cc 10.0.0.105 Member
#    exit 1
#fi

if [ "$action" = "permit" ]; then
    cmd=-A
elif [ "$action" = "deny" ]; then
    cmd=-D
else
    echo "FATAL: Bad action: $action!"
    exit 1
fi

if [ "$class" = "Owner" ]; then
    mark=1
elif [ "$class" = "Member" ]; then
    mark=2
elif [ "$class" = "Public" ]; then
    mark=3
else
    echo "FATAL: Bad class: $class!"
    exit 1
fi

# Mark outbound traffic from this node.
if [ "$mac" == "00:00:00:00:00:00" ]; then
   $IPTABLES -t mangle $cmd NoCat -s $ip -j MARK --set-mark $mark
else
   $IPTABLES -t mangle $cmd NoCat -m mac --mac-source $mac -s $ip -j MARK --set-mark $mark
fi

# Mark inbound traffic to this node.
$IPTABLES -t filter $cmd NoCat_Inbound -d $ip -j ACCEPT

# -------------------------------------------------------------------------
# ACCOUNT traffic of this node.
# -------------------------------------------------------------------------
# if [ "$action" = "permit" ]; then
# 	$IPTABLES -I FORWARD $5 -j ACCOUNT --addr $ip/32 --tname $ip
# elif [ "$action" = "deny" ]; then
# 	RULENUM=`$IPTABLES -L FORWARD | tail -n +3 | grep -n $ip | cut -d':' -f1`
# 	$IPTABLES -D FORWARD $RULENUM
# fi
# -------------------------------------------------------------------------

# End
exit 0
