#!/bin/sh

. ./.function

start_msg XAdES

rm -f tsa_http.log TSA/log \
out/sign.out err/sign.err \
out/archive.out err/archive.err \
out/verify.out err/verify.err \
trace.*sign*.[0-9]* object.*sign*.[0-9]* stack.*sign*.[0-9]* \
trace.*archive*.[0-9]* object.*archive*.[0-9]* stack.*archive*.[0-9]* \
trace.*verify*.[0-9]* object.*verify*.[0-9]* stack.*verify*.[0-9]* \
out/userver_tcp.out err/userver_tcp.err \
trace.*userver_tcp*.[0-9]* object.*userver_tcp*.[0-9]* stack.*userver_tcp*.[0-9]*

UTRACE="0 10M 10"
#UOBJDUMP="0 100k 10"
#USIMERR="error.sim"
#VALGRIND="valgrind -v --leak-check=full"
 export UTRACE UOBJDUMP USIMERR

DIR_CMD="C:/XADES/sbin"

export TMPDIR="C:/TMP"

INPUT=/C/TMP/TESTOPROVA.docx.b64
SCHEMA=/C/XADES/etc/XAdESv141.xsd
DOCUMENT=inp/TESTOPROVA.docx.b64

#STRACE=$TRUSS
#start_prg verify -c XAdES.ini -- $SCHEMA < $INPUT
#rm -rf /c/tmp/XADES
#exit 0

#STRACE=$LTRUSS
#start_prg_background userver_tcp -c tsa_http.cfg

DIR_CA=/C/TMP/
DATA_URI=$DOCUMENT
X509=`cat $DIR_CA/certificate.cer`
KEY_HANDLE=$DIR_CA/server_nopass.key
DIGEST_ALGORITHM=sha256
SIGNING_TIME=0
CLAIMED_ROLE="Amministratore UNIREL"
PRODUCTION_PLACE_CITY="sesto fiorentino"
PRODUCTION_PLACE_STATE_OR_PROVINCE=SI
PRODUCTION_PLACE_POSTAL_CODE=11111
PRODUCTION_PLACE_COUNTRY_NAME=Italy
CA_STORE=$DIR_CA/CApath
SIGNATURE_TIMESTAMP="http://localhost/tsa"
#ZIPPONE=file:///mnt/storage/stefano/XAdES/zippone/LISTACER_20100907.zip.p7m
ZIPPONE=file:///stefano/XAdES/zippone/LISTACER_20101103.zip.p7m

#start_prg feed -c XAdES.ini -- $ZIPPONE
#exit 0

#STRACE=$TRUSS
start_prg sign -c XAdES.ini -- \
 $DATA_URI \
 '"$X509"' \
 $KEY_HANDLE \
 $DIGEST_ALGORITHM \
 $SIGNING_TIME \
 '"$CLAIMED_ROLE"' \
 '"$PRODUCTION_PLACE_CITY"' \
 $PRODUCTION_PLACE_STATE_OR_PROVINCE \
 $PRODUCTION_PLACE_POSTAL_CODE \
 $PRODUCTION_PLACE_COUNTRY_NAME \
  < $DOCUMENT
  #$SIGNATURE_TIMESTAMP
 # $CA_STORE 

exit 0

# ------------------------------------------------------------
# sha1 check:
# ------------------------------------------------------------
# openssl dgst -sha1 -binary < content.xml | openssl base64 -e
# ------------------------------------------------------------
$OPENSSL base64 -e -in out/sign.out -out $INPUT

ARCHIVE_TIMESTAMP="http://localhost/tsa"

#STRACE=$LTRUSS
start_prg archive -c XAdES.ini -- \
		 $ARCHIVE_TIMESTAMP < $INPUT

rm -f $INPUT
mv err/userver_tcp.err err/XAdES.err

$SLEEP
kill_prg userver_tcp TERM

$OPENSSL base64 -e -in out/archive.out -out $INPUT

#STRACE=$LTRUSS
start_prg verify -c XAdES.ini -- \
		 $SCHEMA < $INPUT

# Test against expected output
test_output_wc w archive
