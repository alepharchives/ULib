#!/bin/sh

. ../.function

## web_server.test -- Test web_server feature

start_msg web_server

rm -f web_server.log uploads/* \
      out/userver_tcp.out err/userver_tcp.err \
      trace.*userver_tcp*.[0-9]* object.*userver_tcp*.[0-9]*

#UTRACE="0 5M 0"
#UOBJDUMP="0 100k 10"
#USIMERR="error.sim"
 export UTRACE UOBJDUMP USIMERR

if [ "$TERM" = "msys" ]; then
   export TMPDIR="c:/tmp"
fi

DIR_CMD="../../examples/userver"

##STRACE=$TRUSS
start_prg_background userver_tcp -c web_server.cfg
$SLEEP

#$NC -w 1 127.0.0.1 80 <inp/http/close/06 >>out/web_server.out

LS=`ls inp/http/close`

for i in $LS
do
   $NC -w 2 127.0.0.1 80 <inp/http/close/$i >>out/web_server.out
   $SLEEP
done

touch vuoto.txt

   $NC -w 5 127.0.0.1 80 <inp/http/all.inp  >>out/web_server.out
$SLEEP
   $NC -w 5 127.0.0.1 80 <inp/http/post.inp >>out/web_server.out
$SLEEP

# test upload

mkdir -p uploads
$CURL -s -F 'file=@vuoto.txt'                                -F "name=prova" http://127.0.0.1:80/cgi-bin/uploader.sh >>out/web_server.out 2>>err/web_server.err
$CURL -s -F 'file=@inp/xml2txt/operazione.xml;type=text/xml' -F "name=prova" http://127.0.0.1:80/cgi-bin/uploader.sh >>out/web_server.out 2>>err/web_server.err

diff inp/xml2txt/operazione.xml uploads/operazione.xml
RESULT=$?

kill_prg userver_tcp TERM

mv err/userver_tcp.err err/web_server.err

# Test against expected output
test_output_wc l web_server
