#!/bin/bash

# .base

# global var
BASE_NAME=$(basename $0 .sh)

if [ -z "$HTTP_ACCEPT_LANGUAGE" -o ! -d ../form/$HTTP_ACCEPT_LANGUAGE ]; then
   HTTP_ACCEPT_LANGUAGE=en
fi

FORM_FILE_DIR=../form/$HTTP_ACCEPT_LANGUAGE

# --------------------------------
#  session cookie (no NAT)
# --------------------------------
SESSION_ID=$REMOTE_ADDR
# --------------------------------
#  session cookie (with NAT)
# --------------------------------
#  if [ -n "$HTTP_COOKIE" ]; then
#     SESSION_ID=$HTTP_COOKIE
#  else
#     SET_COOKIE=SESS_$$
#     SESSION_ID=$SET_COOKIE
#  fi
# --------------------------------

if [ -n "$HTTP_HEADER_HOST" ]; then
   SERVER=$HTTP_HEADER_HOST
else
   SERVER=$SERVER_ADDR
fi

# ---------------------------------------------------------------------
# NB: se cambia qualcosa qui, bisogna cambiarlo anche nel .env di admin
# ---------------------------------------------------------------------
DIR_MAIL=../mail
DIR_SCAN=../scan/$SESSION_ID/$BASE_NAME
# ---------------------------------------------------------------------

export OUTPUT BASE_NAME FORM_FILE_DIR TMP_FORM_FILE EXIT_VALUE SET_COOKIE DIR_SCAN DIR_MAIL \
		 NUM_START NUM_END NUM_DOC FOR_PAGE pagina_corrente link_paginazione

write_OUTPUT() {

   if [ -n "$1" ]; then

      if [ -n "$CONNECTION_CLOSE" ]; then
         echo -e "Connection: close\r"
      fi

      if [ -n "$SET_COOKIE" ]; then

         # REQ: Set-Cookie: TODO[ data expire path domain secure HttpOnly ]
         # ----------------------------------------------------------------------------------------------------------------------------
         # string -- Data to put into the cookie         -- must
         # int    -- Lifetime of the cookie in HOURS     -- must (0 -> valid until browser exit)
         # string -- Path where the cookie can be used   --  opt
         # string -- Domain which can read the cookie    --  opt
         # bool   -- Secure mode                         --  opt
         # bool   -- Only allow HTTP usage               --  opt
         # ----------------------------------------------------------------------------------------------------------------------------
         # RET: Set-Cookie: ulib_sid=data&expire&HMAC-MD5(data&expire); expires=expire(GMT); path=path; domain=domain; secure; HttpOnly

         echo -e "Set-Cookie: TODO[ $SET_COOKIE 4320 ]\r" # 180 days

      fi

      echo -e "Content-Type: text/html; charset=utf8\r\n\r"
      echo -n -E "$1"

      exit $EXIT_VALUE

   else

      # BAD REQUEST

      echo -e "Status: 400\r\n\r\n" \
              "<!DOCTYPE HTML PUBLIC \"-//IETF//DTD HTML 2.0//EN\">\r\n" \
              "<html><head>\r\n" \
              "<title>400 Bad Request</title>\r\n" \
              "</head><body>\r\n" \
              "<h1>Bad Request</h1>\r\n" \
              "<p>Your browser sent a request that this server could not understand.<br />\r\n" \
              "</p>\r\n" \
              "<hr>\r\n" \
              "<address>ULib Server</address>\r\n" \
              "</body></html>\r"

      exit 0

   fi
}

# more environment...
if [ -n "$FILE_TO_SOURCE" ]; then
   . $FILE_TO_SOURCE
fi
